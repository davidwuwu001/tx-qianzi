# 本地运行指南

本指南将帮助你从零开始在本地运行腾讯电子签便捷签约系统。

## 📋 前置要求

在开始之前，请确保你的开发环境已安装以下软件：

- **Node.js** 20+ （推荐使用 LTS 版本）
- **MySQL** 8.0+ （本地安装或使用云数据库）
- **npm** 或 **yarn** 或 **pnpm** （包管理器）

### 检查环境

```bash
# 检查 Node.js 版本
node --version  # 应该 >= 20.0.0

# 检查 npm 版本
npm --version

# 检查 MySQL 是否运行
mysql --version
```

---

## 🚀 快速开始

### 第一步：安装依赖

```bash
# 进入项目目录
cd tx-qianzi

# 安装依赖
npm install
```

### 第二步：配置数据库

#### 2.1 创建数据库

在 MySQL 中创建一个新数据库：

```sql
CREATE DATABASE tencent_esign CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

#### 2.2 配置环境变量

复制环境变量示例文件：

```bash
# Windows (PowerShell)
Copy-Item .env.example .env

# Linux/Mac
cp .env.example .env
```

编辑 `.env` 文件，配置数据库连接：

```env
DATABASE_URL="mysql://root:你的密码@localhost:3306/tencent_esign"
```

**注意**：请将 `你的密码` 替换为你的 MySQL root 密码。

### 第三步：初始化数据库

```bash
# 生成 Prisma 客户端
npx prisma generate

# 推送数据库结构到数据库
npx prisma db push

# 运行数据库种子脚本（创建测试数据）
npm run db:seed
```

**种子脚本会创建**：
- 一个测试城市（北京）
- 一个系统管理员账号（用户名: `sysadmin`, 密码: `SysAdmin123!`）
- 一个城市管理员账号（用户名: `cityadmin`, 密码: `CityAdmin123!`）
- 一个测试产品

### 第四步：配置 NextAuth 密钥

生成一个随机的 NextAuth 密钥：

```bash
# Windows (PowerShell)
[Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Maximum 256 }))

# Linux/Mac
openssl rand -base64 32
```

将生成的密钥填入 `.env` 文件：

```env
NEXTAUTH_SECRET="你生成的密钥"
NEXTAUTH_URL="http://localhost:3000"
```

### 第五步：启动开发服务器

```bash
npm run dev
```

打开浏览器访问：**http://localhost:3000**

---

## 🔐 登录测试

### 管理员登录

访问：**http://localhost:3000/login**

使用种子脚本创建的账号登录：

- **系统管理员**：
  - 用户名：`sysadmin`
  - 密码：`SysAdmin123!`

- **城市管理员**：
  - 用户名：`cityadmin`
  - 密码：`CityAdmin123!`

### 移动端登录

访问：**http://localhost:3000/m/login**

移动端使用验证码登录，需要先创建普通用户账号。

---

## 📱 创建普通用户

### 方式一：使用脚本创建

```bash
node scripts/create-ordinary-user.mjs
```

### 方式二：在管理后台创建

1. 使用系统管理员登录
2. 进入"用户管理"页面
3. 点击"创建用户"
4. 选择角色为"普通用户"
5. 填写手机号、姓名等信息

---

## 🔧 腾讯电子签配置（可选）

如果你需要测试完整的签署流程，需要配置腾讯电子签 API。

### 1. 获取腾讯云 API 密钥

1. 访问 [腾讯云控制台](https://console.cloud.tencent.com/)
2. 进入 [API 密钥管理](https://console.cloud.tencent.com/cam/capi)
3. 创建新密钥，获取 `SecretId` 和 `SecretKey`

### 2. 开通电子签服务

1. 访问 [电子签控制台](https://qian.tencent.com/)
2. 完成企业认证
3. 获取操作员 `UserId`（企业中心 → 员工管理）

### 3. 创建合同模板

1. 在电子签控制台创建合同模板
2. 记录模板 ID

### 4. 配置环境变量

在 `.env` 文件中添加：

```env
# 腾讯电子签环境：test（联调环境）或 prod（正式环境）
TENCENT_ESIGN_ENV="test"

# API 密钥
# 联调环境：使用电子签控制台生成的专用密钥（AKyD... 开头）
# 正式环境：使用腾讯云 API 密钥（AKID... 开头）
TENCENT_SECRET_ID="你的SecretId"
TENCENT_SECRET_KEY="你的SecretKey"
TENCENT_ESIGN_OPERATOR_ID="你的UserId"

# 乙方企业信息（你的公司，自动盖章）
PARTY_A_ORG_NAME="你的公司名称"
PARTY_A_SIGNER_NAME="签署人姓名"
PARTY_A_SIGNER_MOBILE="签署人手机号"
```

**角色说明**：
- **乙方** = 你的公司（发起方，自动盖章）
- **甲方** = 客户（接收方，需要手动签署）

### 5. 验证配置

```bash
node scripts/verify-api-integration.mjs
```

如果看到 "✓ API 配置验证成功"，说明配置正确！

---

## 🛠️ 常用命令

```bash
# 开发服务器
npm run dev              # 启动开发服务器（http://localhost:3000）

# 数据库操作
npx prisma generate      # 生成 Prisma 客户端
npx prisma db push       # 推送数据库结构
npx prisma studio        # 打开 Prisma Studio（数据库可视化工具）
npm run db:seed         # 运行数据库种子脚本

# 构建和部署
npm run build           # 构建生产版本
npm start               # 启动生产服务器

# 代码质量
npm run lint            # 运行 ESLint 检查

# 测试
npm test                # 运行测试
npm run test:watch      # 监听模式运行测试

# 用户管理脚本
node scripts/create-user.mjs              # 创建管理员用户
node scripts/create-ordinary-user.mjs     # 创建普通用户
```

---

## 🐛 常见问题

### Q1: 数据库连接失败

**错误信息**：`Can't reach database server`

**解决方案**：
1. 检查 MySQL 服务是否运行
2. 检查 `.env` 中的 `DATABASE_URL` 是否正确
3. 检查数据库用户名和密码是否正确
4. 检查数据库是否已创建

### Q2: Prisma 客户端生成失败

**错误信息**：`Prisma Client has not been generated yet`

**解决方案**：
```bash
npx prisma generate
```

### Q3: 端口 3000 已被占用

**错误信息**：`Port 3000 is already in use`

**解决方案**：
1. 关闭占用 3000 端口的程序
2. 或修改端口：在 `package.json` 中修改 `dev` 脚本：
   ```json
   "dev": "next dev -p 3001"
   ```

### Q4: NextAuth 错误

**错误信息**：`NEXTAUTH_SECRET is not set`

**解决方案**：
1. 确保 `.env` 文件中设置了 `NEXTAUTH_SECRET`
2. 重新启动开发服务器

### Q5: 登录后页面空白

**可能原因**：
1. 数据库中没有用户数据
2. 运行 `npm run db:seed` 创建测试数据

### Q6: 移动端页面样式异常

**解决方案**：
1. 清除浏览器缓存
2. 重启开发服务器
3. 检查 Tailwind CSS 配置

---

## 📚 下一步

配置完成后，你可以：

1. **浏览管理后台**
   - 访问 http://localhost:3000/contracts 查看合同管理
   - 访问 http://localhost:3000/users 管理用户
   - 访问 http://localhost:3000/products 管理产品

2. **测试移动端**
   - 访问 http://localhost:3000/m 查看移动端首页
   - 创建普通用户并登录测试

3. **测试签署流程**（需要配置腾讯电子签）
   - 在移动端发起签约
   - 查看签署链接生成
   - 测试完整的签署流程

4. **查看项目文档**
   - 阅读 `.kiro/` 目录下的设计文档
   - 查看 API 文档和代码注释

---

## 💡 提示

- 开发环境使用 `npm run dev` 启动，支持热重载
- 使用 `npx prisma studio` 可以可视化查看数据库数据
- 所有环境变量都在 `.env` 文件中配置，不要提交到 Git
- 遇到问题可以查看控制台错误信息，或查看项目文档

---

## 🆘 需要帮助？

如果遇到问题：

1. 检查控制台错误信息
2. 查看项目文档（`.kiro/` 目录）
3. 检查环境变量配置
4. 确认所有依赖已正确安装

祝你开发愉快！🎉



